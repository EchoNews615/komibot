import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Loader2, RefreshCw, Users, ShieldAlert, VolumeX, Gavel, Clock } from "lucide-react";

/**
 * Painel elegante e responsivo para listar /api/members com auto-refresh.
 *
 * Como usar em produção:
 *  - Sirva este arquivo como sua página inicial (Vite/Next ou build estático).
 *  - Configure a variável VITE_API_BASE_URL, ou deixe vazia para usar o mesmo domínio.
 *  - Ex.: VITE_API_BASE_URL=https://komibot-6vv4.onrender.com
 */

const API_BASE = (import.meta?.env?.VITE_API_BASE_URL ?? "").trim();
const API = (path) => `${API_BASE}${path}`;

export default function MembersDashboard() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("user_tag");
  const [sortDir, setSortDir] = useState("asc");
  const [intervalMs, setIntervalMs] = useState(5000); // padrão 5s
  const timerRef = useRef(null);

  const fetchMembers = async () => {
    try {
      setLoading(true);
      setError("");
      const res = await fetch(API("/api/members"));
      if (!res.ok) throw new Error(`Falha ${res.status}`);
      const json = await res.json();
      setData(Array.isArray(json) ? json : []);
    } catch (e) {
      setError(e?.message || "Erro ao carregar");
    } finally {
      setLoading(false);
    }
  };

  // Auto-refresh com controle de intervalo + pausa em aba oculta
  useEffect(() => {
    fetchMembers();
    const startTimer = () => {
      clearInterval(timerRef.current);
      if (intervalMs > 0) timerRef.current = setInterval(fetchMembers, intervalMs);
    };
    startTimer();
    const onVis = () => {
      if (document.hidden) {
        clearInterval(timerRef.current);
      } else {
        fetchMembers();
        startTimer();
      }
    };
    document.addEventListener("visibilitychange", onVis);
    return () => {
      clearInterval(timerRef.current);
      document.removeEventListener("visibilitychange", onVis);
    };
  }, [intervalMs]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let rows = q
      ? data.filter((r) =>
          (r.user_tag || "").toLowerCase().includes(q) ||
          (r.user_id || "").toLowerCase().includes(q)
        )
      : data;
    rows = [...rows].sort((a, b) => {
      const va = a?.[sortKey] ?? 0;
      const vb = b?.[sortKey] ?? 0;
      if (typeof va === "string" || typeof vb === "string") {
        return sortDir === "asc"
          ? String(va).localeCompare(String(vb))
          : String(vb).localeCompare(String(va));
      }
      return sortDir === "asc" ? va - vb : vb - va;
    });
    return rows;
  }, [data, query, sortKey, sortDir]);

  const Stat = ({ icon: Icon, label, value }) => (
    <Card className="rounded-2xl shadow-sm">
      <CardContent className="p-5 flex items-center gap-4">
        <div className="p-3 rounded-2xl bg-gray-100">
          <Icon className="w-6 h-6" />
        </div>
        <div>
          <div className="text-2xl font-semibold leading-tight">{value}</div>
          <div className="text-sm text-gray-500">{label}</div>
        </div>
      </CardContent>
    </Card>
  );

  const totals = useMemo(() => {
    const t = { warns: 0, mutes: 0, bans: 0 };
    for (const r of data) {
      t.warns += r.total_warns || 0;
      t.mutes += r.total_mutes || 0;
      t.bans += r.total_bans || 0;
    }
    return t;
  }, [data]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-white via-slate-50 to-white">
      <div className="max-w-7xl mx-auto px-4 py-8">
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
          <div>
            <motion.h1
              initial={{ opacity: 0, y: 6 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.35 }}
              className="text-3xl md:text-4xl font-bold tracking-tight"
            >
              Painel de Moderação — Membros
            </motion.h1>
            <p className="text-gray-600 mt-1">
              Atualização automática • Fonte: <code className="bg-gray-100 px-1 rounded">/api/members</code>
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Select value={String(intervalMs)} onValueChange={(v) => setIntervalMs(Number(v))}>
              <SelectTrigger className="w-44">
                <SelectValue placeholder="Auto-refresh" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="1000">1s</SelectItem>
                <SelectItem value="2000">2s</SelectItem>
                <SelectItem value="5000">5s</SelectItem>
                <SelectItem value="10000">10s</SelectItem>
                <SelectItem value="30000">30s</SelectItem>
                <SelectItem value="0">Pausado</SelectItem>
              </SelectContent>
            </Select>
            <Button variant="outline" onClick={fetchMembers} disabled={loading} className="gap-2">
              {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
              Atualizar
            </Button>
          </div>
        </header>

        <section className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Stat icon={Users} label="Membros" value={data.length} />
          <Stat icon={ShieldAlert} label="Warns (total)" value={totals.warns} />
          <Stat icon={VolumeX} label="Mutes (total)" value={totals.mutes} />
          <Stat icon={Gavel} label="Bans (total)" value={totals.bans} />
        </section>

        <Card className="rounded-2xl shadow-sm">
          <CardHeader className="pb-3">
            <div className="flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <CardTitle className="text-xl">Lista de membros</CardTitle>
              <div className="flex w-full md:w-auto gap-2">
                <Input
                  placeholder="Buscar por nome ou ID"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  className="md:w-72"
                />
                <Select value={sortKey} onValueChange={setSortKey}>
                  <SelectTrigger className="w-40">
                    <SelectValue placeholder="Ordenar por" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="user_tag">Nome</SelectItem>
                    <SelectItem value="user_id">ID</SelectItem>
                    <SelectItem value="total_warns">Warns</SelectItem>
                    <SelectItem value="total_mutes">Mutes</SelectItem>
                    <SelectItem value="total_bans">Bans</SelectItem>
                  </SelectContent>
                </Select>
                <Select value={sortDir} onValueChange={setSortDir}>
                  <SelectTrigger className="w-28">
                    <SelectValue placeholder="Direção" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="asc">Crescente</SelectItem>
                    <SelectItem value="desc">Decrescente</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardHeader>
          <CardContent className="p-0">
            <div className="overflow-auto">
              <table className="w-full text-sm">
                <thead className="sticky top-0 bg-white/70 backdrop-blur border-b">
                  <tr className="text-left">
                    <th className="px-4 py-3 font-medium">Usuário</th>
                    <th className="px-4 py-3 font-medium">ID</th>
                    <th className="px-4 py-3 font-medium">Warns</th>
                    <th className="px-4 py-3 font-medium">Mutes</th>
                    <th className="px-4 py-3 font-medium">Bans</th>
                    <th className="px-4 py-3 font-medium">Última ação</th>
                    <th className="px-4 py-3 font-medium">Tickets</th>
                  </tr>
                </thead>
                <tbody>
                  {loading && (
                    <tr>
                      <td colSpan={7} className="px-4 py-6 text-center text-gray-500">
                        Carregando…
                      </td>
                    </tr>
                  )}
                  {!loading && filtered.length === 0 && (
                    <tr>
                      <td colSpan={7} className="px-4 py-10 text-center text-gray-500">
                        Nada encontrado.
                      </td>
                    </tr>
                  )}
                  {!loading && filtered.map((r) => (
                    <tr key={r.user_id} className="border-t hover:bg-gray-50/60">
                      <td className="px-4 py-3">
                        <div className="font-medium">{r.user_tag || "—"}</div>
                        <div className="text-xs text-gray-500">Policy: {r.last_punishment?.type ?? "—"}</div>
                      </td>
                      <td className="px-4 py-3 text-gray-600">{r.user_id}</td>
                      <td className="px-4 py-3">
                        <Badge variant={r.total_warns ? "default" : "secondary"}>{r.total_warns}</Badge>
                      </td>
                      <td className="px-4 py-3">
                        <Badge variant={r.total_mutes ? "default" : "secondary"}>{r.total_mutes}</Badge>
                      </td>
                      <td className="px-4 py-3">
                        <Badge variant={r.total_bans ? "destructive" : "secondary"}>{r.total_bans}</Badge>
                      </td>
                      <td className="px-4 py-3 text-gray-600 flex items-center gap-2">
                        <Clock className="w-4 h-4" />
                        <span className="truncate max-w-[16rem]">
                          {r.last_punishment?.timestamp || "—"}
                        </span>
                      </td>
                      <td className="px-4 py-3">{r.tickets ?? 0}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {error && (
              <div className="px-4 py-3 text-sm text-red-600 border-t bg-red-50">{error}</div>
            )}
          </CardContent>
        </Card>

        <footer className="text-center text-xs text-gray-500 mt-8">
          UI por KomiBot • Build elegante, profissional e responsivo
        </footer>
      </div>
    </div>
  );
}
      <div class="mb-4 flex gap-3 items-center">
        <input id="search" placeholder="Buscar por nome/ID..." class="bg-gray-800 rounded px-3 py-2 w-full outline-none border border-gray-700 focus:border-indigo-500"/>
        <button id="reload" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded">Recarregar</button>
      </div>
      <table class="table-auto w-full border-collapse">
        <thead>
          <tr class="text-indigo-400 border-b border-gray-700">
            <th class="text-left py-2 px-4">Usuário</th>
            <th class="text-left py-2 px-4">Advertências</th>
            <th class="text-left py-2 px-4">Mutes</th>
            <th class="text-left py-2 px-4">Bans</th>
            <th class="text-left py-2 px-4">Tickets</th>
            <th class="text-left py-2 px-4">Última Punição</th>
            <th class="text-left py-2 px-4">Ações</th>
          </tr>
        </thead>
        <tbody id="members-table"></tbody>
      </table>
    </div>
  </section>

  <section id="reports">
    <h2 class="text-xl font-semibold mb-4 text-indigo-300">📂 Relatórios Mensais</h2>
    <div class="card p-6">
      <div class="flex items-center gap-3 mb-4">
        <input id="month" type="month" class="bg-gray-800 rounded px-3 py-2 outline-none border border-gray-700 focus:border-indigo-500"/>
        <button id="export" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded">Gerar Exportação</button>
      </div>
      <ul id="report-links" class="space-y-2 text-indigo-400"></ul>
    </div>
  </section>
</main>

<footer class="bg-gray-900 py-6 mt-10">
  <div class="max-w-7xl mx-auto px-6 text-gray-500 text-sm text-center">
    Feito com ❤️ por <span class="text-indigo-400">NanyDev</span> • KomiBot © 2025
  </div>
</footer>

<script>
  const API = location.origin.replace(/\/$/, '') // mesmo host
  const GUILD_ID = ""; // opcional

  async function fetchMembers(){
    const url = GUILD_ID ? `${API}/api/members?guild=${GUILD_ID}` : `${API}/api/members`;
    const res = await fetch(url);
    return res.json();
  }

  function fmtLast(p){
    if (!p) return '-';
    const d = new Date(p.timestamp);
    return `${p.type} - ${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
  }

  function renderMembers(list){
    const tbody = document.getElementById('members-table');
    tbody.innerHTML = '';
    let totalWarns = 0, totalMutes = 0, totalBans = 0, totalTickets = 0;
    for (const m of list){
      totalWarns += m.total_warns||0;
      totalMutes += m.total_mutes||0;
      totalBans  += m.total_bans||0;
      totalTickets += m.tickets||0;
      const tr = document.createElement('tr');
      tr.className = "border-b border-gray-800 hover:bg-gray-800/50";
      tr.innerHTML = `
        <td class="py-2 px-4">${m.user_tag}</td>
        <td class="py-2 px-4">${m.total_warns||0}</td>
        <td class="py-2 px-4">${m.total_mutes||0}</td>
        <td class="py-2 px-4">${m.total_bans||0}</td>
        <td class="py-2 px-4">${m.tickets||0}</td>
        <td class="py-2 px-4">${fmtLast(m.last_punishment)}</td>
        <td class="py-2 px-4">
          <a href="member.html?id=${m.user_id}" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded">Ver/a>
        </td>`;
      tbody.appendChild(tr);
    }
    document.getElementById("card-warns").innerText = totalWarns;
    document.getElementById("card-mutes").innerText = totalMutes;
    document.getElementById("card-bans").innerText  = totalBans;
    document.getElementById("card-tickets").innerText = totalTickets;
  }

  async function load(){
    let list = await fetchMembers();
    const search = document.getElementById('search');
    function apply(){
      const q = (search.value||'').toLowerCase();
      renderMembers(list.filter(m => (m.user_tag||'').toLowerCase().includes(q) || (m.user_id||'').includes(q)));
    }
    search.addEventListener('input', apply);
    document.getElementById('reload').addEventListener('click', async ()=>{ list = await fetchMembers(); apply(); });
    apply();

    const month = document.getElementById('month');
    month.value = new Date().toISOString().slice(0,7);
    const links = document.getElementById('report-links');
    document.getElementById('export').addEventListener('click', async ()=>{
      const ym = month.value;
      const res = await fetch(`${API}/api/export/monthly`, { method:'POST', headers:{'Content-Type':'application/json','x-api-key':'${"${"}SITE_API_KEY?:""}'}, body: JSON.stringify({ month: ym }) });
      const j = await res.json().catch(()=>({}));
      links.innerHTML = '';
      if (j.files){
        ['xlsx','pdf'].forEach(ext => {
          if (j.files[ext]){
            const li = document.createElement('li');
            li.innerHTML = `<a class="hover:underline" href="${j.files[ext]}">${ym.toUpperCase()} • baixar ${ext.toUpperCase()}</a>`;
            links.appendChild(li);
          }
        });
      }
    });
  }
  load().catch(console.error);
</script>
</body>
</html>
